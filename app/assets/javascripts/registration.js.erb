// Place all the behaviors and hooks related to the matching controller here.
// All this logic will automatically be available in application.js.

$(function() {
  if ($('body').hasClass('registration photo')) {
    initSeenly();
    initCropper();
  }

  // study form widget
  var studyWidget = $('form .study-field select');
  studyWidget.change(function() {
    var enableOther = $('option:selected', this).text() == "Andere"
    var other = $(this).parent().siblings('.study-field-other');
    if(enableOther) { other.show(); $('input', other).attr('disabled', false); }
    else { other.hide(); $('input', other).attr('disabled', true); }
  });

  // make sure that everything is show correctly on page load
  studyWidget.each(function(i, e) {
    var other = $(e).parent().siblings('.study-field-other');
    if($(e).val() != $('input', other).val()) {
      $('option:last', e).attr('selected', true);
    }
  });
  studyWidget.change();
})

function initSeenly() {
  var seenly = new Seenly();
  seenly.swfURL = "<%= asset_path('Seenly.swf') %>";
  seenly.imageWidth = 350; seenly.imageHeight = 450;
  seenly.viewfinderWidth = 350; seenly.viewfinderHeight = 450;
  seenly.embed('seenly-embed');

  var field = $('#member_photo_base64_input input');
  var frozen = false;
  $('#seenly-snap').click(function() {
    if(!frozen) {
      seenly.freeze();
      $('#seenly-submit').attr('disabled', false);
      $(this).val("Nieuwe foto");
    }
    else {
      seenly.thaw();
      $('#seenly-submit').attr('disabled', true);
      $(this).val("Foto nemen");
    }
    frozen = !frozen;
  });

  $('#seenly-submit').click(function() {
    field.val(seenly.getBase64());

    // dismiss modal window and submit
    $('#dialog:ui-dialog').dialog('destroy');
    field.parents('form').submit();
  });

  $('a.seenly').click(function() {
    $('#dialog:ui-dialog').dialog('destroy');
    $('#seenly-modal').dialog({
      modal: true, draggable: false, resizable: false,
      width: 600, height: 580
    });
    return false;
  });
}

function initCropper() {
  var previewImg = $('#crop-preview img');
  var largeImg = $('#crop-image');

  var updateCrop = function(coords) {
    var rx = previewImg.parent().width() / coords.w;
    var ry = previewImg.parent().height() / coords.h;
    previewImg.css({
      width: Math.round(rx * largeImg.width()) + 'px',
      height: Math.round(ry * largeImg.height()) + 'px',
      marginLeft: '-' + Math.round(rx * coords.x) + 'px',
      marginTop: '-' + Math.round(ry * coords.y) + 'px'
    });

    $('#member_crop_x').val(coords.x);
    $('#member_crop_y').val(coords.y);
    $('#member_crop_w').val(coords.w);
    $('#member_crop_h').val(coords.h);
  }

  var aspectRatio = 350/450; //210/270
  var initial = {
    x: Number($('#member_crop_x').val()), y: Number($('#member_crop_y').val()),
    w: Number($('#member_crop_w').val()), h: Number($('#member_crop_h').val())
  }
  if(initial.w == 0 || initial.h == 0) {
    initial = { x: 50, y: 10, w: 315, h: 405 };
  }

  $('body.registration.photo #crop-image').Jcrop({
    setSelect: [initial.x, initial.y, initial.x + initial.w, initial.y + initial.h],
    aspectRatio: aspectRatio,
    onChange: updateCrop,
    onSelect: updateCrop
  });
}
